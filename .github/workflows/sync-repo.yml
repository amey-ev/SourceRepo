name: Sync Lambda to Terraform

on:
  push:
    branches:
      - main  # Runs when code is pushed to main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Lambda Repo
        uses: actions/checkout@v3

      - name: Run Bash Script to Zip Selected Folders
        run: |
          #!/bin/bash

          REPO_URL="https://github.com/YOUR_GITHUB_USERNAME/YOUR_LAMBDA_REPO.git"
          TEMP_DIR="repo_temp"
          BASE_DIR="lambdas"
          FOLDERS=("devtools" "codebase" "quickstart" "testbench")

          echo "üöÄ Cloning repository..."
          git clone "$REPO_URL" "$TEMP_DIR" || { echo "‚ùå Clone failed. Exiting..."; exit 1; }

          cd "$TEMP_DIR" || exit

          for folder in "${FOLDERS[@]}"; do
              if [ -d "$folder" ]; then
                  TARGET_DIR="../$BASE_DIR/$folder"
                  mkdir -p "$TARGET_DIR"

                  echo "üì¶ Zipping and moving $folder..."
                  zip -rq "$TARGET_DIR/$folder.zip" "$folder"
              else
                  echo "‚ö†Ô∏è Skipping missing folder: $folder"
              fi
          done

          cd ..
          echo "üßπ Cleaning up..."
          rm -rf "$TEMP_DIR"

          echo "‚úÖ Done!"

      - name: Clone Terraform Repo
        run: |
          git clone https://github.com/YOUR_GITHUB_USERNAME/YOUR_TERRAFORM_REPO.git terraform-repo
          mv -v lambdas/* terraform-repo/lambdas/

      - name: Commit and Push to Terraform Repo
        run: |
          cd terraform-repo
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add lambdas/
          git commit -m "Updated Lambda zips from latest commit"
          git push https://x-access-token:${{ secrets.TERRAFORM_REPO_TOKEN }}@github.com/YOUR_GITHUB_USERNAME/YOUR_TERRAFORM_REPO.git main
