name: Copy Folder with History

on:
  push:
    branches:
      - main  # Or another branch to trigger the action

jobs:
  copy-folder:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the source repository
      uses: actions/checkout@v3
      with:
        repository: amey-ev/SourceRepo
        ref: main  # Or another branch
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout the destination repository (DestinationRepo)
      uses: actions/checkout@v3
      with:
        repository: amey-ev/DestinationRepo
        token: ${{ secrets.GITHUB_TOKEN }}
        path: DestinationRepo/TestFolders

    - name: Copy folder from source to destination repository
      run: |
        mkdir -p DestinationRepo/TestFolders
        git --no-pager log --oneline --reverse --pretty=format:"%H" SourceRepo/codebase | while read commit_hash; do
          git checkout $commit_hash -- SourceRepo/path/to/source/folder
          cp -r SourceRepo/codebase DestinationRepo/TestFolders
          git -C DestinationRepo add TestFolders
          git -C DestinationRepo commit --amend --no-edit --date "$(date)"
        done

    - name: Push changes to destination repository
      run: |
        git -C DestinationRepo push origin main  # Or the branch you want to push to
