name: Sync Lambda to Terraform

on:
  push:
    branches:
      - main  

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Lambda Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Set GitHub Token
        run: echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Get Changed Folders & Author Info
        id: changed_folders
        run: |
          echo "üîç Checking changed folders..."
          CHANGED_FOLDERS=$(git diff --name-only HEAD^ HEAD | awk -F'/' '{print $1}' | sort -u | uniq)

          FILTERED_FOLDERS=""
          for folder in $CHANGED_FOLDERS; do
            if [[ "$folder" != ".github" && "$folder" != ".gitignore" && -d "$folder" ]]; then
              FILTERED_FOLDERS+="$folder "
            fi
          done

          FILTERED_FOLDERS=$(echo "$FILTERED_FOLDERS" | tr '\n' ' ')

          AUTHOR_NAME=$(git log -1 --pretty=format:'%an' | tr ' ' '-')
          DATE_FORMATTED=$(date +"%d-%b-%Y" | sed -E 's/^0//')

          echo "folders=$FILTERED_FOLDERS" >> $GITHUB_ENV
          echo "author=$AUTHOR_NAME" >> $GITHUB_ENV
          echo "date=$DATE_FORMATTED" >> $GITHUB_ENV

      - name: Zip Only Changed Folders
        run: |
          mkdir -p zipped_files
          for folder in ${{ env.folders }}; do
            if [ -d "$folder" ]; then
              zip -r "zipped_files/${folder}.zip" "$folder"
            fi
          done

      - name: Clone Terraform Repo
        run: |
          git clone https://github.com/amey-ev/DestinationRepo.git destination-repo
          cd destination-repo
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Push Changes to New Branch
        run: |
          cd destination-repo
          for folder in ${{ env.folders }}; do
            if [ -f "../zipped_files/${folder}.zip" ]; then
              mv "../zipped_files/${folder}.zip" "lambdas/"
              BRANCH_NAME="update-${folder}-${{ env.author }}-${{ env.date }}"
              BRANCH_NAME=$(echo "$BRANCH_NAME" | tr ' ' '-')

              git checkout -b "$BRANCH_NAME"
              git add "lambdas/${folder}.zip"
              git commit -m "Updated Lambda zip for ${folder} by ${{ env.author }} on ${{ env.date }}"
              git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/amey-ev/DestinationRepo.git "$BRANCH_NAME"
            fi
          done

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîê Logging in to GitHub CLI..."
          echo $GH_TOKEN | gh auth login --with-token

          cd destination-repo
          for folder in ${{ env.folders }}; do
            PR_TITLE="Sync Lambda changes for ${folder} by ${{ env.author }} on ${{ env.date }}"
            gh pr create --base main --head "update-${folder}-${{ env.author }}-${{ env.date }}" --title "$PR_TITLE" --body "Automated PR to sync changes."
          done
